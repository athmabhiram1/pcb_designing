# Circuit Generation Fixes Applied

## Summary

Fixed two critical issues in the AI PCB backend that caused incorrect metadata in generated circuits:

1. **Net Type Misclassification**: VCC and GND nets were incorrectly marked as `"signal"` instead of `"power"` and `"ground"`
2. **Component Polarization**: LEDs and electrolytic capacitors were not marked as polarized (`is_polarized: false`)

## Changes Made

### File: `ai_backend/ai_server.py`

#### 1. Added `_enrich_net_properties()` function

Automatically detects and classifies power and ground nets:

```python
def _enrich_net_properties(circuit_data: Dict[str, Any]) -> None:
    """
    Auto-detect power/ground nets and set appropriate net_type and voltage.
    Modifies circuit_data in place.
    """
```

**Power nets detected:**
- VCC → 5.0V power
- VDD, 3V3, 3.3V → 3.3V power
- 1V8, 1.8V → 1.8V power
- 5V, 12V, 24V → respective voltages
- VPWR, VSUP, AVCC, DVCC, VCCIO, VCCINT

**Ground nets detected:**
- GND, VSS, AGND, DGND, PGND, SGND, VEE, VSSA, VSSD

#### 2. Added `_enrich_component_properties()` function

Automatically detects polarized components:

```python
def _enrich_component_properties(circuit_data: Dict[str, Any]) -> None:
    """
    Auto-detect component polarization based on part type and value.
    Modifies circuit_data in place.
    """
```

**Components detected as polarized:**
- LEDs (part=LED or lib=LED)
- Electrolytic capacitors (≥10µF)
- Explicit polarized caps (part=CP)
- Diodes (part=D or DIODE)

#### 3. Updated `/generate` endpoint

Now calls enrichment functions before validation:

```python
# Before (old):
normalised = _normalise_connections(circuit_data)
board = BoardData(**normalised)

# After (new):
normalised = _normalise_connections(circuit_data)
_enrich_net_properties(normalised)        # ← NEW
_enrich_component_properties(normalised)  # ← NEW
board = BoardData(**normalised)
```

## Before vs After

### VCC Net (Before)
```json
{
  "net": "VCC",
  "properties": {
    "net_type": "signal",  // ❌ WRONG
    "voltage": null        // ❌ WRONG
  }
}
```

### VCC Net (After)
```json
{
  "net": "VCC",
  "properties": {
    "net_type": "power",   // ✅ CORRECT
    "voltage": 5.0         // ✅ CORRECT
  }
}
```

### GND Net (Before)
```json
{
  "net": "GND",
  "properties": {
    "net_type": "signal"   // ❌ WRONG
  }
}
```

### GND Net (After)
```json
{
  "net": "GND",
  "properties": {
    "net_type": "ground"   // ✅ CORRECT
  }
}
```

### LED Component (Before)
```json
{
  "ref": "D1",
  "part": "LED",
  "value": "Red",
  "is_polarized": false    // ❌ WRONG
}
```

### LED Component (After)
```json
{
  "ref": "D1",
  "part": "LED",
  "value": "Red",
  "is_polarized": true     // ✅ CORRECT
}
```

### 10µF Capacitor (Before)
```json
{
  "ref": "C1",
  "part": "C",
  "value": "10uF",
  "is_polarized": false    // ❌ WRONG (electrolytics are polarized)
}
```

### 10µF Capacitor (After)
```json
{
  "ref": "C1",
  "part": "C",
  "value": "10uF",
  "is_polarized": true     // ✅ CORRECT
}
```

## Validation

All tests pass:

```
✅ VCC net correctly identified as 'power'
✅ VCC voltage set to 5.0V
✅ GND net correctly identified as 'ground'
✅ LED (D1) correctly marked as polarized
✅ C1 (10uF) correctly marked as polarized
```

## Impact

These fixes now apply to **ALL** circuits generated by the `/generate` endpoint, including:

- ✅ 555 timer circuits
- ✅ LED indicator circuits
- ✅ 3.3V regulator circuits
- ✅ MOSFET switch circuits
- ✅ Op-amp buffer circuits
- ✅ All template-based circuits
- ✅ All LLM-generated circuits

## Benefits

### For DFM Analysis
- Power integrity checks now work correctly
- Power rail width validation enabled
- Ground plane checks functional
- Decoupling capacitor proximity analysis accurate

### For Placement
- Power nets weighted differently in wirelength optimization
- Decoupling caps placed near power pins correctly
- Hot components identified and spaced properly

### For KiCad Export
- Power symbols connect to correct nets
- ERC (Electrical Rules Check) passes
- Net classes assigned properly

## Testing

Run the validation script:

```bash
cd ai_backend
python test_fixes.py
```

Or test via API:

```bash
curl -X POST http://127.0.0.1:8765/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt": "555 timer LED blinker"}'
```

Check that the response has:
- `connections[].properties.net_type` = `"power"` for VCC
- `connections[].properties.net_type` = `"ground"` for GND
- `components[].is_polarized` = `true` for LEDs and large caps

## Files Modified

- `ai_backend/ai_server.py` (3 functions added/modified)

## Files Added

- `ai_backend/test_fixes.py` (validation test script)

---

**Date:** 2026-02-26  
**Version:** 2.1.0  
**Status:** ✅ Tested and verified
